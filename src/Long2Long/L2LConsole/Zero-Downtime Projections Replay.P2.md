## Zero-Downtime Projections 再生 - Robert Baelde - DDD Europe 2023

**講演者:**

* Robert Baelde

**イベント:**

* Domain-Driven Design Europe 2023

**視聴数:**

* 566 回

**日時:**

* 2024 年 2 月 15 日

**主催:**

* Aardling

**説明:**

イベントソーシングにおけるプロジェクションの再生は、システムの読み取りモデルの一貫性と正確性を確保するための重要なタスクです。規模の大きなストリームをダウンタイムなしに処理するには、さまざまな戦略が必要になります。本講演では、利用可能な戦略と適切な戦略の選択方法について詳しく説明します。
## イベントストリームの課題

ダッシュボード作成を断念したのは、システムに負荷がかかるためでした。しかし、イベントストリームで実行されるクエリと安定したトレースアクションは、イベントがテーブルで10万件を超えると影響を受けました。

## プロジェクションの検討

ライブイベントでのシステム停止を回避するため、プロジェクションの検討を開始しました。イベントのソーシングに関するカンファレンスでその可能性について議論しています。

### プロジェクションの仕組み

プロジェクションはストリームの最後の状態の障害です。状態は前の状態の突然変異で、新しいイベントが適用されると更新されます。

### 簡単な例

トークンを預け入れ、費用を支払うイベントストリームがあるとします。トークンはプラスで、ウォレットの残高の状態を追跡するには、イベントを再生して残高を更新する必要があります。

## アシスタントの役割

アシスタントは、夜間リプレイや最初のウェズリーの再生を処理する可能性があります。新しいプロジェクションを導入する際にも使用できます。
## プロジェクターの利用方法

### イベントツアー

プライバシーに敏感な情報が含まれていないことを確認する必要があります。削除した後にプロジェクターを再生して、技術専門家が確認を行います。

### プロジェクターの利用上の注意

* 常に同じ結果を出すこと
* ランダムに生成されたアイデアや、以前の仕事で得られたアイデアを使用しないこと
## プロジェクターの再生時間

**プロジェクターの範囲を投影から外す**

イベントのテーマに関連しないため、プロジェクターの範囲を投影から外します。

**再生回数の減少**

プロジェクターを再生する回数を減らします。

**再生時間の短縮**

再生時間を可能な限り短くします。

**再生イベントの削減**

再生するイベントの数を減らします。
**イベントの処理**

**システム内のイベント**

システム内には膨大な数のイベントがあり、処理に時間がかかる場合があります。

**パーティション処理**

すべてのイベントを処理するのではなく、特定のアカウントの種類やイベントタイプに基づいてイベントをパーティション化することで、処理時間を短縮できます。

**並列処理**

複数のコンテナを使用してイベントを並列に処理し、処理時間をさらに短縮できます。

**集計ルートID**

特定の集計ルートIDに基づいてイベントを投影することで、特定の祭りやウォレット残高などの集計を効率的に取得できます。

**パーティション基準**

イベントを分割する基準として、ウォレットのフェスティバルキーやアクロバットタイプなどのプロパティを使用できます。
**ポーションの処理**

**イベントの処理**

* ポーション関数を実行。
* 保護機能はイベントの違いによって異なる。
* イベントを消費することでプロセスを処理。
* ポーションを acu にプッシュ。
* empal Jackson が空になり、新しいイベントテーマにプッシュ。
* イベントストリームの特定のパーティションを再生。
* すべてのイベントを再生する必要はない。
* ローリングアップデートの実行。

**プロセスごとの処理**

* 各ポーションにプロセスが存在。
* dplay を処理。
* ポーションが小さい場合、再生がオフに。
* 短時間で処理が可能。

**パーティショニング**

* パーティショナーはパーティションキーを返す。
* プロジェクターに適用。
* プロジェクターの書き込みでは、パーティションの状態をリセット。

**ウォレット ID によるパーティショニング**

* ウォレット ID でパーティションを作成。
* 特定のウォレットの残高をリセット。

**内部イベントストリーム**

* イベントは段階的。
* ユーザー名とユーザーメールの更新。
* 顧客が重視するのは検証されたユーザー。
**イベントの管理**

**パブリックイベントのモデリング**

リアクターのイベントを監視するには、**nation so connectie listen to waldo's**を使用します。

* **検証済みイベント:**
    * アリゾナストリームと内部ストリームを組み合わせてパブリックイベントモッドペイロードを作成します。
    * 消費者に合わせてより具体的に指定できます。
* **パブリックストリームへのパブリッシュ:**
    * 消費者がパブリックストリームからイベントを監視できます。

**リアクターの管理**

リアクターは二重化が必要です。

* **イベントの状態の保持:**
    * 発生したイベントと検証済みイベントの状態を保持します。
* **パブリックストリームへの配信:**
    * 状態を反映したイベントをパブリックストリームに配信します。

**トランジショナルイベントの活用**

サービスを保護するためにトランジショナルイベントを使用します。

* **ポリシーの適用:**
    * プロパティの変更を検知し、プレミアムの再計算をトリガーします。
* **プレミアムの導入:**
    * 2017年に新しいイベントのバランスを導入しました。
* **現在の関心事の把握:**
    * 最新のイベントのみを考慮します。
* **計算の軽減:**
    * 最終的なイベントのみで計算を実行します。

**イベント数の削減**

イベント数を削減する技術。

* **スナップショット:**
    * イベントを定期的にスナップショット化して、再作成時間を短縮します。
* **リプレイ:**
    * 壊れたイベントを特定し、削除します。
**プロジェクターとスナップショットの管理**

**スナップショットと再生**

- 既知のチャショットベロートのスナップショットから開始し、状態にして再生します。
- すべての失われた VI イベントを再生します。

**スナップショットの用途**

- プロジェクターと作業のスナップショット状態を作成できます。
- バンギングでは、今年の終わりにストリームを閉じて新しいストリームを開始します。
- ストリームを短く保つという概念があります。

**スナップショットの制限**

- プロジェクターはスナップショットではありません。
- スナップショットはさまざまなストリームの集約です。
- 生産においては、スナップショットを作成してもそれほど重要ではありません。

**スナップショットの管理**

- 小さなインフラストラクチャの懸念名とラスシーを削除するスナップショットを作成します。
- スナップショットはもう一度水和されます。
- プロジェクターでは、バックグラウンドで単に再生してスナップショットを作成します。
- 再生する必要があるイベントの数である die の結論を把握します。
**イベント処理**

**平均時間の確認**

プロジェクターが検出していない場合、イベントごとに申請するために提出します。

**イベントの格納および再生**

esquel の声明またはすべてのイベントを格納する声明を使用して、各イベントを再生してライドを再作成します。

**ディスクへの作業の書き込み**

ディスクへの書き込みタスクは、イベントストリームです。

**イベントの更新**

イベントを再生する必要がある場合は、更新を 1 つの特定の更新にバッチ処理する必要があります。

**最初の状態の適用**

更新するにもかかわらず、アルファベットの最初の状態を適用し、メモリに保存します。

**Ride TV のトラフィックの節約**

Ride TV のトラフィックを節約するには、最初の状態を適用します。

**イベントの処理**

現在メモリで行われているイベントのロード状態を処理する必要があります。

**バッジ内のイベントの処理**

バッジ内のイベントは、バッジを再度状態にコミットするだけです。

**ステレオのリプレイ**

ステレオのリプレイ時間を実行する必要があります。

**インフラストラクチャスライド**

**ユーザー情報の更新**

イベントを更新して、そのユーザーの新しいバージョンが更新イベントに登場します。

**処理の順序**

イベントを処理する順序は重要です。古いイベントによってライドオンがオーバーライドされるためです。

**バランスの更新**

バランスを更新して、実施したアクションが Yoko Zoomer で計算されるようにします。

**再生成成状態**

イベントを 2 回処理すると、バランスが間違ったものになります。再生成成状態は、ダウンタイムなしで再生に使用できます。
**リクエストの正確化**

* システムへの適切な乗り物のリクエストが可能。
* upoe の操作をストア。

**イベント処理の課題**

* イベントを 2 つのプロジェクターにプッシュしても、1 つずつ処理されない。
* イベントの処理に失敗した場合の対処。

**ゾンビープロセスの回避**

* イベント取得の失敗回避。
* プロジェクター前にインターデューキューを挿入。

**イベント処理の改善**

* イベントのキュー処理。
* ehm によるキュー管理と防御処理。
* outbox のようなアンプによるイベントの確実なキュー送信。

**リプレイ機能の実装**

* 単一プロジェクターでのリプレイ。
* プロジェクションのコピー/クローン作成。
* イベントストアのイベント横断検索と同時再生。

**リプレイの課題**

* リプレイ時の ehm による新規イベント受信停止。

**処理完了後の処理**

* イベント処理後のオブジェクトへの処理移行。
* リプレイプロジェクションの遅延。

**レガシーシステムの課題**

* ワークオーバーでのイベント作成回避。
## イベントストアの責務

- イベントストアの責務はRシステムのイベントを保管することであるべきです。
- イベントの読み取りのためではなく、プロジェクションに関するものである必要があります。
- イベントストアはプロジェクションマネージャーを複雑なものとして認識し、イベントをジャクソンに適用します。このコードは何度も繰り返されます。

## 利点

- インターフェイスはイベントストアの1つの責任に対処します。
- プロジェクションはビートの責任を負います。
- イベントストアとの単純なインターフェイスがあるため、これは実際に結合です。
- プロジェクションの並列処理にも優れた利点が得られます。

## さらなる利点

- イベントドリームへのオフセットが表示されるため、プロテクションの半分ですぐに洞察を得ることができます。
- デルタを簡単に確認できます。
## イベントの処理

イベント構造には、左側と右側にイベントがあります。

イベントのドアは、パーティションキーを残してパーティション関数を推測し、特定のパーティションキーの前のオフセットを求めます。

イベントストアに「最後のイベント以降のすべてのイベントをください」と尋ねます。

イベントストアからイベントを取得します。

投影マネージャーに「このステータス以降のすべてのイベントをください」と尋ねます。

イベントストアは投影マネージャーにイベントを提供します。

ステータスがわからないイベントがある場合は、新しいオフセットをゼロに設定します。

イベントを処理します。

マネージャーは、パーティションキーが含まれているので、「OK、AVのチェックポイントを取得します」と言います。

初期チェックポイントを返します。

イベントを取得して、最後のイベントストアのチェックポイントを変更し、トランザクションで再処理します。

チェックポイントを計算します。
## イベントの再生

### 実行方法

* プロジェクターを空けて横に置く。
* 不動産とオフセットをゼロに設定する。
* イベントストアでイベントをゼロから再処理する。
* 再生プロジェクターが元のプロジェクターから逸脱している場合は、オフセットをラベルデルタに設定する。
* オフセットが元の1に近い場合は、再処理を1から切り替える。

### スナップチャットでの利用

* スナップチャット用に組織的な柔軟性を内部化する。
* 問題がある場合は、保護を並べてオフセットを設定する。
* プロジェクションマネージャーは、イベントのベストと嵐の後、セクションを失うようにする。
* プロジェクションアクションが認識されるように、異なるレベルのAssenで燃料を供給する。

### 展開方法

* 異なるアプリケーションのリリースを使用して展開する。
* プロジェクションが認識されている場合は、データをデータストアに保存するよう指示する。
* プロジェクションが再生モードで再生されると、別のストアに書き込まれる。
* 製作をライブにする場合は、ストアの領域使用またはテーブルの名前を変更する。
* 再生は、異なる実装に対して認識する必要がある。
## リポジトリとエントロピーの管理

リポジトリは特定のテーブルを使用する必要があります。リプレイの再生時に RB でチェックする必要があります。

シムズで使用されていた元の入力機能は機能します。バージョン 2 をライブに持ってくることができます。

バージョン 1 からバージョン 2 に移動する元の 1 を使用します。そしてその日の終わりに、エントロピーはオリジナルのものを日没させることができます。

新しいバージョンまたはバージョンをライブにしたい場合は、状態はケイトに才能を貸してみんなでリプレイしましょう。

ブーツでバージョン 2 がライブになっています。
## リプレイ戦略

### ポイントによるリプレイ

* リプレイは、ポイントの下にのみ必要。

### リプレイ時間

* プライムタイムは2以上。
* 最大リプレイ時間。

### リプレイ速度

* リプレイが遅い場合は、エームヨジェをスローダウン。

### リプレイの活用

* 展開時間を好みに調整。
* シルバーバレットのリプレイを適用。

### システムの活用

* 適したシステムを選び、組み合わせる。
* ヘンリー作品を初期段階で考慮。
* イベントの多さや時間による調整。

### 反応の迅速化

* リプレイを早期に見て、遅れに注意。
* アシスタンスの周波数が問題に。

### プレゼンテーションの締め

* プレゼンターがクリックして終了。